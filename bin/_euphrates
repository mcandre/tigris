#!/bin/sh
unset IFS
set -euf
TARGET_DIR="$1"
TRIM_LEFT="$2"
TRIM_TOP="$3"
TRIM_RIGHT="$4"
TRIM_BOTTOM="$5"
SOURCE_FILE="$6"
mkdir -p "$TARGET_DIR"
B="$(basename "$SOURCE_FILE")"
C="$TARGET_DIR/$B"
ORIGINAL_DIMENSIONS="$(magick identify "$SOURCE_FILE" |
    awk 'match($0, /[0-9]+x[0-9]+/) { print substr($0, RSTART, RLENGTH) }')"
ORIGINAL_WIDTH="${ORIGINAL_DIMENSIONS%x*}"
ORIGINAL_HEIGHT="${ORIGINAL_DIMENSIONS#*x}"
WIDTH=$((ORIGINAL_WIDTH - TRIM_LEFT - TRIM_RIGHT))
HEIGHT=$((ORIGINAL_HEIGHT - TRIM_TOP - TRIM_BOTTOM))
magick \
    "$SOURCE_FILE" \
    -crop \
    "${WIDTH}x${HEIGHT}+${TRIM_LEFT}+${TRIM_TOP}" \
    "PNG32:${C}"
